<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin da Programação</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="img/icon.png">
    <link rel="shortcut icon" href="img/icon.png" type="image/x-icon">

    <style>
        :root {
            --bg-page: #121212;
            --bg-card: #1E1E1E;
            --bg-header: linear-gradient(90deg, #1e3a8a, #2563eb);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EAEAEA;
            --text-secondary: #A9A9AA;
            --text-on-accent: #FFFFFF;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #ffab00;
            --neutral-gray: #555555;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px 15px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .admin-container {
            width: 100%;
            max-width: 900px;
            margin: 25px auto 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }

        .form-section,
        .program-table-section {
            background-color: var(--bg-card);
            padding: 25px;
            border-radius: var(--border-radius-md);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .form-section h2,
        .program-table-section h2 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input[type="time"],
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-page);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-yellow);
        }

        .form-group-checkbox {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 0, 0.05);
            border-left: 3px solid var(--accent-yellow);
            border-radius: var(--border-radius-sm);
        }

        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            color: var(--text-on-accent);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        button:disabled {
            cursor: not-allowed;
            background-color: var(--neutral-gray);
            filter: brightness(0.7);
        }

        #logoutBtn {
            background-color: var(--accent-red);
        }

        #saveTitleBtn,
        #saveLocationBtn,
        #saveActivityBtn {
            background-color: var(--accent-green);
        }

        #clearLocationFormBtn,
        #clearActivityFormBtn {
            background-color: var(--neutral-gray);
            color: var(--text-primary);
        }

        .action-buttons button.edit-btn,
        .action-buttons button.edit-location-btn {
            background-color: var(--accent-yellow);
            color: #1c1c1c;
        }

        .action-buttons button.delete-btn,
        .action-buttons button.delete-location-btn {
            background-color: var(--accent-red);
        }

        .table-responsive-wrapper {
            overflow-x: auto;
        }

        .table-responsive-wrapper table {
            width: 100%;
            min-width: 600px;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .table-responsive-wrapper th,
        .table-responsive-wrapper td {
            padding: 15px 20px;
            text-align: left;
            font-size: 16px;
            vertical-align: middle;
        }

        .table-responsive-wrapper thead tr {
            background: var(--bg-header);
        }

        .table-responsive-wrapper thead th {
            background: transparent;
            color: var(--text-on-accent);
            font-weight: 600;
            border: none;
        }

        .table-responsive-wrapper thead th:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        .table-responsive-wrapper thead th:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        .table-responsive-wrapper tbody tr {
            background-color: var(--bg-page);
        }

        .table-responsive-wrapper tbody tr:hover {
            background-color: #2a2a2a;
        }

        .table-responsive-wrapper tbody td:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        .table-responsive-wrapper tbody td:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #locationListBody td:nth-child(2) {
            width: 1%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-buttons button {
            padding: 8px 12px;
            font-size: 14px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0px);
            }
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .loading-indicator.active {
            display: block;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .admin-container {
                padding: 0;
            }

            .admin-header h1 {
                font-size: 28px;
            }

            .form-section,
            .program-table-section {
                padding: 20px;
            }

            .form-section h2,
            .program-table-section h2 {
                font-size: 22px;
            }

            .table-responsive-wrapper table {
                min-width: 100%;
            }
        }
    </style>
</head>

<body class="dark-mode">
    <div class="admin-container">
        <div class="admin-header">
            <h1>Dashboard Programação</h1>
            <button id="logoutBtn">Sair</button>
        </div>

        <div class="form-section">
            <h2>Configurações Gerais</h2>
            <form id="titleForm">
                <div class="form-group">
                    <label for="pageTitleInput">Título da Página Principal:</label>
                    <input type="text" id="pageTitleInput" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" id="saveTitleBtn">Salvar Título</button>
                </div>
            </form>
        </div>

        <div class="form-section">
            <h2>Gerenciar Locais</h2>
            <form id="locationForm">
                <input type="hidden" id="locationDocId">
                <div class="form-group">
                    <label for="locationName">Nome do Local:</label>
                    <input type="text" id="locationName" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" id="saveLocationBtn">Adicionar Local</button>
                    <button type="button" id="clearLocationFormBtn">Limpar</button>
                </div>
            </form>
            <div class="table-responsive-wrapper" style="margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Nome do Local</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="locationListBody"></tbody>
                </table>
            </div>
        </div>

        <div class="form-section">
            <h2>Adicionar/Editar Atividade</h2>
            <form id="activityForm">
                <input type="hidden" id="activityDocId">
                <div class="form-group">
                    <label for="activityTime">Horário de Início:</label>
                    <input type="time" id="activityTime" required>
                </div>
                <div class="form-group">
                    <label for="activityDuration">Duração (em minutos):</label>
                    <input type="number" id="activityDuration" min="1" placeholder="Ex: 60" required>
                </div>
                <div class="form-group">
                    <label for="activityName">Atividade:</label>
                    <input type="text" id="activityName" required>
                </div>
                <div class="form-group">
                    <label for="activityLocationSelect">Local:</label>
                    <select id="activityLocationSelect" required>
                        <option value="">Selecione um local</option>
                    </select>
                </div>
                <div class="form-group-checkbox" id="autoAdjustContainer">
                    <input type="checkbox" id="autoAdjustCheckbox">
                    <label for="autoAdjustCheckbox">Reajustar horários subsequentes</label>
                </div>
                <div class="form-buttons">
                    <button type="submit" id="saveActivityBtn">Adicionar Atividade</button>
                    <button type="button" id="clearActivityFormBtn">Limpar</button>
                </div>
            </form>
        </div>

        <div class="program-table-section">
            <h2>Programação Atual</h2>
            <div class="loading-indicator" id="loadingIndicator">Carregando programação...</div>
            <div class="table-responsive-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Horário</th>
                            <th>Atividade</th>
                            <th>Local</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="adminProgramBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8EGMHVUVTrNWY2wai3YmXE1ZrlZ6Gz6o",
            authDomain: "programacao-9b5ff.firebaseapp.com",
            projectId: "programacao-9b5ff",
            storageBucket: "programacao-9b5ff.appspot.com",
            messagingSenderId: "454543714542",
            appId: "1:454543714542:web:0d57bf8de021d5e79e6bff",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const programCollectionRef = collection(db, 'eventProgram');
        const locationsCollectionRef = collection(db, 'eventLocations');
        const siteConfigRef = doc(db, 'site_config', 'main_settings');

        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logoutBtn');
            const adminProgramBody = document.getElementById('adminProgramBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const titleForm = document.getElementById('titleForm');
            const pageTitleInput = document.getElementById('pageTitleInput');
            const saveTitleBtn = document.getElementById('saveTitleBtn');
            const locationForm = document.getElementById('locationForm');
            const locationDocIdInput = document.getElementById('locationDocId');
            const locationNameInput = document.getElementById('locationName');
            const saveLocationBtn = document.getElementById('saveLocationBtn');
            const clearLocationFormBtn = document.getElementById('clearLocationFormBtn');
            const locationListBody = document.getElementById('locationListBody');
            const activityForm = document.getElementById('activityForm');
            const activityDocIdInput = document.getElementById('activityDocId');
            const activityTimeInput = document.getElementById('activityTime');
            const activityDurationInput = document.getElementById('activityDuration');
            const autoAdjustContainer = document.getElementById('autoAdjustContainer');
            const autoAdjustCheckbox = document.getElementById('autoAdjustCheckbox');
            const activityNameInput = document.getElementById('activityName');
            const activityLocationSelect = document.getElementById('activityLocationSelect');
            const saveActivityBtn = document.getElementById('saveActivityBtn');
            const clearActivityFormBtn = document.getElementById('clearActivityFormBtn');

            let program = [];
            let locations = [];
            let refreshProgramIntervalId = null;
            let refreshLocationsIntervalId = null;

            if (localStorage.getItem('loggedIn') !== 'true') {
                window.location.href = 'login.html';
                return;
            }

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('loggedIn');
                window.location.href = 'login.html';
            });

            async function loadPageTitle() {
                try {
                    const docSnap = await getDoc(siteConfigRef);
                    if (docSnap.exists() && docSnap.data().pageTitle) {
                        pageTitleInput.value = docSnap.data().pageTitle;
                    }
                } catch (error) {
                    console.error("Erro ao carregar o título:", error);
                }
            }

            titleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveTitleBtn.disabled = true;
                saveTitleBtn.textContent = 'Salvando...';
                const newTitle = pageTitleInput.value.trim();

                try {
                    await setDoc(siteConfigRef, { pageTitle: newTitle }, { merge: true });
                    alert('Título atualizado com sucesso!');
                } catch (error) {
                    console.error("Erro ao salvar o título:", error);
                    alert('Ocorreu um erro ao salvar o título.');
                } finally {
                    saveTitleBtn.disabled = false;
                    saveTitleBtn.textContent = 'Salvar Título';
                }
            });

            async function loadLocationsFromFirestore() {
                try {
                    const q = query(locationsCollectionRef, orderBy("name"));
                    const querySnapshot = await getDocs(q);
                    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Erro ao carregar locais:", error);
                    return [];
                }
            }

            function renderLocations() {
                locationListBody.innerHTML = '';
                activityLocationSelect.innerHTML = '<option value="">Selecione um local</option>';

                if (locations.length === 0) {
                    locationListBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Nenhum local cadastrado.</td></tr>';
                    return;
                }

                locations.forEach(loc => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${loc.name}</td>
                        <td class="action-buttons">
                            <button class="edit-location-btn" data-id="${loc.id}">Editar</button>
                            <button class="delete-location-btn" data-id="${loc.id}">Excluir</button>
                        </td>`;
                    locationListBody.appendChild(row);

                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    activityLocationSelect.appendChild(option);
                });
            }

            locationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveLocationBtn.disabled = true;
                saveLocationBtn.textContent = 'Salvando...';
                const name = locationNameInput.value.trim();
                const docIdValue = locationDocIdInput.value;

                if (!name) {
                    alert("Por favor, preencha o nome do local!");
                    saveLocationBtn.disabled = false;
                    saveLocationBtn.textContent = 'Adicionar Local';
                    return;
                }

                try {
                    if (docIdValue) {
                        await updateDoc(doc(db, "eventLocations", docIdValue), { name });
                    } else {
                        await addDoc(locationsCollectionRef, { name });
                    }
                    await refreshLocationsDataAndUI();
                    clearLocationForm();
                } catch (error) {
                    console.error("Erro ao salvar local:", error);
                } finally {
                    saveLocationBtn.disabled = false;
                    saveLocationBtn.textContent = locationDocIdInput.value ? 'Salvar Edição' : 'Adicionar Local';
                }
            });

            function clearLocationForm() {
                locationForm.reset();
                locationDocIdInput.value = '';
                saveLocationBtn.textContent = 'Adicionar Local';
                locationNameInput.focus();
            }

            clearLocationFormBtn.addEventListener('click', clearLocationForm);

            locationListBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const docId = target.dataset.id;
                const location = locations.find(l => l.id === docId);

                if (target.classList.contains('edit-location-btn')) {
                    locationNameInput.value = location.name;
                    locationDocIdInput.value = location.id;
                    saveLocationBtn.textContent = 'Salvar Edição';
                    locationNameInput.focus();
                } else if (target.classList.contains('delete-location-btn')) {
                    if (confirm(`Tem certeza que deseja excluir o local "${location.name}"?`)) {
                        try {
                            await deleteDoc(doc(db, "eventLocations", docId));
                            await refreshLocationsDataAndUI();
                            await refreshAdminProgramDataAndTable();
                        } catch (error) {
                            console.error("Erro ao excluir local:", error);
                        }
                    }
                }
            });

            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            const minutesToTime = (totalMinutes) => {
                const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
                const minutes = (totalMinutes % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            };

            activityForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveActivityBtn.disabled = true;
                saveActivityBtn.textContent = 'Salvando...';

                const activityData = {
                    time: activityTimeInput.value,
                    duration: parseInt(activityDurationInput.value, 10),
                    activity: activityNameInput.value,
                    locationId: activityLocationSelect.value
                };
                const docIdValue = activityDocIdInput.value;

                if (!activityData.time || !activityData.duration || !activityData.activity || !activityData.locationId) {
                    alert("Por favor, preencha todos os campos da atividade!");
                    saveActivityBtn.disabled = false;
                    saveActivityBtn.textContent = 'Adicionar Atividade';
                    return;
                }

                if (docIdValue && autoAdjustCheckbox.checked) {
                    try {
                        const batch = writeBatch(db);
                        const sortedProgram = [...program].sort((a, b) => a.time.localeCompare(b.time));
                        const editedItemIndex = sortedProgram.findIndex(item => item.id === docIdValue);
                        if (editedItemIndex === -1) throw new Error("Item editado não foi encontrado.");

                        const editedDocRef = doc(db, "eventProgram", docIdValue);
                        batch.update(editedDocRef, activityData);

                        let lastEndTimeInMinutes = timeToMinutes(activityData.time) + activityData.duration;

                        for (let i = editedItemIndex + 1; i < sortedProgram.length; i++) {
                            const currentItem = sortedProgram[i];
                            const newStartTime = minutesToTime(lastEndTimeInMinutes);
                            batch.update(doc(db, "eventProgram", currentItem.id), { time: newStartTime });
                            lastEndTimeInMinutes += currentItem.duration;
                        }

                        await batch.commit();
                        alert('Programação reajustada com sucesso!');
                    } catch (error) {
                        console.error("Erro no reajuste automático: ", error);
                        alert("Ocorreu um erro ao reajustar os horários.");
                    }
                } else {
                    try {
                        if (docIdValue) {
                            await updateDoc(doc(db, "eventProgram", docIdValue), activityData);
                        } else {
                            await addDoc(programCollectionRef, activityData);
                        }
                    } catch (error) {
                        console.error("Erro ao salvar atividade: ", error);
                    }
                }

                await refreshAdminProgramDataAndTable();
                clearActivityForm();
                saveActivityBtn.disabled = false;
                saveActivityBtn.textContent = 'Adicionar Atividade';
            });

            function clearActivityForm() {
                activityForm.reset();
                activityDocIdInput.value = '';
                saveActivityBtn.textContent = 'Adicionar Atividade';
                autoAdjustContainer.style.display = 'none';
                autoAdjustCheckbox.checked = false;
                activityTimeInput.focus();
            }

            clearActivityFormBtn.addEventListener('click', clearActivityForm);

            adminProgramBody.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                const docIdValue = targetButton.dataset.id;
                const item = program.find(item => item.id === docIdValue);

                if (targetButton.classList.contains('edit-btn')) {
                    activityTimeInput.value = item.time;
                    activityDurationInput.value = item.duration || '';
                    activityNameInput.value = item.activity;
                    activityLocationSelect.value = item.locationId;
                    activityDocIdInput.value = docIdValue;
                    saveActivityBtn.textContent = 'Salvar Edição';
                    autoAdjustContainer.style.display = 'flex';
                    activityTimeInput.focus();
                } else if (targetButton.classList.contains('delete-btn')) {
                    if (confirm(`Tem certeza que deseja excluir "${item.activity}"?`)) {
                        await deleteDoc(doc(db, "eventProgram", docIdValue));
                        await refreshAdminProgramDataAndTable();
                    }
                }
            });

            async function loadProgramFromFirestore() {
                loadingIndicator.classList.add('active');
                try {
                    const q = query(programCollectionRef);
                    const querySnapshot = await getDocs(q);
                    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("Erro ao carregar programação: ", error);
                    return [];
                } finally {
                    loadingIndicator.classList.remove('active');
                }
            }

            function renderAdminProgram() {
                adminProgramBody.innerHTML = '';
                if (program.length === 0 && !loadingIndicator.classList.contains('active')) {
                    adminProgramBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhuma atividade programada.</td></tr>';
                    return;
                }

                const sortedProgram = [...program].sort((a, b) => a.time.localeCompare(b.time));

                sortedProgram.forEach(item => {
                    const locationName = locations.find(loc => loc.id === item.locationId)?.name || 'N/D';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.time}</td>
                        <td>${item.activity}</td>
                        <td>${locationName}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-id="${item.id}">Editar</button>
                            <button class="delete-btn" data-id="${item.id}">Excluir</button>
                        </td>`;
                    adminProgramBody.appendChild(row);
                });
            }

            async function refreshAdminProgramDataAndTable() {
                program = await loadProgramFromFirestore();
                renderAdminProgram();
            }

            async function refreshLocationsDataAndUI() {
                locations = await loadLocationsFromFirestore();
                renderLocations();
            }

            async function initializeAdminPage() {
                await loadPageTitle();
                await refreshLocationsDataAndUI();
                await refreshAdminProgramDataAndTable();

                if (refreshProgramIntervalId) clearInterval(refreshProgramIntervalId);
                refreshProgramIntervalId = setInterval(refreshAdminProgramDataAndTable, 10000);

                if (refreshLocationsIntervalId) clearInterval(refreshLocationsIntervalId);
                refreshLocationsIntervalId = setInterval(refreshLocationsDataAndUI, 3000);
            }

            initializeAdminPage();
        });
    </script>
</body>

</html>