<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin da Programação</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="img/icon.png">
    <link rel="shortcut icon" href="img/icon.png" type="image/x-icon">

    <style>
        :root {
            --bg-page: #121212;
            --bg-card: #1E1E1E;
            --bg-header: linear-gradient(90deg, #1e3a8a, #2563eb);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EAEAEA;
            --text-secondary: #A9A9AA;
            --text-on-accent: #FFFFFF;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #ffab00;
            --neutral-gray: #555555;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px 15px;
            background-color: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .admin-container {
            width: 100%;
            max-width: 900px;
            margin: 25px auto 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }

        .form-section,
        .program-table-section {
            background-color: var(--bg-card);
            padding: 25px;
            border-radius: var(--border-radius-md);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .form-section h2,
        .program-table-section h2 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group select {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-page);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-yellow);
        }

        .form-group-checkbox {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 0, 0.05);
            border-left: 3px solid var(--accent-yellow);
            border-radius: var(--border-radius-sm);
        }

        .form-group-checkbox label {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            color: var(--text-on-accent);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        button:disabled {
            cursor: not-allowed;
            background-color: var(--neutral-gray);
            filter: brightness(0.7);
        }

        #logoutBtn {
            background-color: var(--accent-red);
        }

        #saveConfigBtn,
        #saveLocationBtn,
        #saveDayBtn,
        #saveActivityBtn {
            background-color: var(--accent-green);
        }

        #clearLocationFormBtn,
        #clearDayFormBtn,
        #clearActivityFormBtn {
            background-color: var(--neutral-gray);
            color: var(--text-primary);
        }

        .action-buttons button.edit-btn,
        .action-buttons button.edit-location-btn,
        .action-buttons button.edit-day-btn {
            background-color: var(--accent-yellow);
            color: #1c1c1c;
        }

        .action-buttons button.delete-btn,
        .action-buttons button.delete-location-btn,
        .action-buttons button.delete-day-btn {
            background-color: var(--accent-red);
        }

        #logoPreview {
            max-width: 200px;
            margin-top: 15px;
            border-radius: var(--border-radius-sm);
            background-color: var(--bg-page);
            padding: 5px;
        }

        .table-responsive-wrapper {
            overflow-x: auto;
        }

        .table-responsive-wrapper table {
            width: 100%;
            min-width: 600px;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .table-responsive-wrapper th,
        .table-responsive-wrapper td {
            padding: 15px 20px;
            text-align: left;
            font-size: 16px;
            vertical-align: middle;
        }

        .table-responsive-wrapper thead tr {
            background: var(--bg-header);
        }

        .table-responsive-wrapper thead th {
            background: transparent;
            color: var(--text-on-accent);
            font-weight: 600;
            border: none;
        }

        .table-responsive-wrapper thead th:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        .table-responsive-wrapper thead th:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        .table-responsive-wrapper tbody tr {
            background-color: var(--bg-page);
        }

        .table-responsive-wrapper tbody tr:hover {
            background-color: #2a2a2a;
        }

        .table-responsive-wrapper tbody td:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        .table-responsive-wrapper tbody td:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #locationListBody td:nth-child(2),
        #dayListBody td:nth-child(3) {
            width: 1%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-buttons button {
            padding: 8px 12px;
            font-size: 14px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0px);
            }
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .loading-indicator.active {
            display: block;
        }

        .url-copy-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .url-copy-wrapper input {
            flex-grow: 1;
        }

        #copyUrlBtn {
            background-color: #2563eb;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .admin-container {
                padding: 0;
            }

            .admin-header h1 {
                font-size: 28px;
            }

            .form-section,
            .program-table-section {
                padding: 20px;
            }

            .form-section h2,
            .program-table-section h2 {
                font-size: 22px;
            }

            .table-responsive-wrapper table {
                min-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="loader">
        <h2 style="text-align: center; padding-top: 50px;">Verificando autenticação...</h2>
    </div>

    <div id="main-content" style="display: none;">
        <div class="admin-container">
            <div class="admin-header">
                <h1>Dashboard Programação</h1>
                <button id="logoutBtn">Sair</button>
            </div>

            <div class="form-section">
                <h2>Configurações Gerais</h2>
                <form id="siteConfigForm">
                    <div class="form-group">
                        <label for="pageTitleInput">Título da Página Principal:</label>
                        <input type="text" id="pageTitleInput" required>
                    </div>

                    <div class="form-group">
                        <label for="logoUploadInput">Logo do Evento (deixe em branco para manter a atual)</label>
                        <input type="file" id="logoUploadInput"
                            accept="image/png, image/jpeg, image/gif, image/svg+xml">
                        <img id="logoPreview" src="" alt="Pré-visualização da logo" style="display: none;">
                    </div>

                    <div class="form-group">
                        <label for="eventUrlInput">URL para compartilhar seu evento:</label>
                        <div class="url-copy-wrapper">
                            <input type="text" id="eventUrlInput" readonly>
                            <button type="button" id="copyUrlBtn">Copiar URL</button>
                        </div>
                        <span id="copyUrlFeedback"
                            style="display: none; color: var(--accent-green); margin-top: 8px;">URL Copiada!</span>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="saveConfigBtn">Salvar Configurações</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h2>Gerenciar Dias do Evento</h2>
                <form id="dayForm">
                    <input type="hidden" id="dayDocId">
                    <div class="form-group">
                        <label for="dayName">Nome do Dia (Ex: Dia 1, Sexta-feira):</label>
                        <input type="text" id="dayName" required>
                    </div>
                    <div class="form-group">
                        <label for="dayDate">Data do Dia:</label>
                        <input type="date" id="dayDate" required>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="saveDayBtn">Adicionar Dia</button>
                        <button type="button" id="clearDayFormBtn">Limpar</button>
                    </div>
                </form>
                <div class="table-responsive-wrapper" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Dia</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="dayListBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="form-section">
                <h2>Gerenciar Locais</h2>
                <form id="locationForm">
                    <input type="hidden" id="locationDocId">
                    <div class="form-group">
                        <label for="locationName">Nome do Local:</label>
                        <input type="text" id="locationName" required>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="saveLocationBtn">Adicionar Local</button>
                        <button type="button" id="clearLocationFormBtn">Limpar</button>
                    </div>
                </form>
                <div class="table-responsive-wrapper" style="margin-top: 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Local</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="locationListBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="form-section">
                <h2>Adicionar/Editar Atividade</h2>
                <form id="activityForm">
                    <input type="hidden" id="activityDocId">

                    <div class="form-group">
                        <label for="activityDaySelect">Dia do Evento:</label>
                        <select id="activityDaySelect" required>
                            <option value="">Primeiro, cadastre e selecione um dia</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="activityTime">Horário de Início:</label>
                        <input type="time" id="activityTime" required>
                    </div>
                    <div class="form-group">
                        <label for="activityDuration">Duração (em minutos):</label>
                        <input type="number" id="activityDuration" min="1" placeholder="Ex: 60" required>
                    </div>
                    <div class="form-group">
                        <label for="activityName">Atividade:</label>
                        <input type="text" id="activityName" required>
                    </div>
                    <div class="form-group">
                        <label for="activityLocationSelect">Local:</label>
                        <select id="activityLocationSelect" required>
                            <option value="">Selecione um local</option>
                        </select>
                    </div>
                    <div class="form-group-checkbox" id="autoAdjustContainer">
                        <input type="checkbox" id="autoAdjustCheckbox">
                        <label for="autoAdjustCheckbox">Reajustar horários subsequentes neste dia</label>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" id="saveActivityBtn">Adicionar Atividade</button>
                        <button type="button" id="clearActivityFormBtn">Limpar</button>
                    </div>
                </form>
            </div>

            <div class="program-table-section">
                <h2>Programação Atual</h2>

                <div class="form-group">
                    <label for="dayFilterSelect">Visualizar programação do dia:</label>
                    <select id="dayFilterSelect">
                        <option value="">Nenhum dia cadastrado</option>
                    </select>
                </div>

                <div class="loading-indicator" id="loadingIndicator">Carregando programação...</div>
                <div class="table-responsive-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Horário</th>
                                <th>Atividade</th>
                                <th>Local</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="adminProgramBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8EGMHVUVTrNWY2wai3YmXE1ZrlZ6Gz6o",
            authDomain: "programacao-9b5ff.firebaseapp.com",
            projectId: "programacao-9b5ff",
            storageBucket: "programacao-9b5ff.appspot.com",
            messagingSenderId: "454543714542",
            appId: "1:454543714542:web:0d57bf8de021d5e79e6bff",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');

        let currentUserId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                loader.style.display = 'none';
                mainContent.style.display = 'block';
                runAdminLogic();
            } else {
                window.location.href = 'login.html';
            }
        });

        function runAdminLogic() {
            const daysCollectionRef = collection(db, 'user_data', currentUserId, 'eventDays');
            const programCollectionRef = collection(db, 'user_data', currentUserId, 'eventProgram');
            const locationsCollectionRef = collection(db, 'user_data', currentUserId, 'eventLocations');
            const siteConfigRef = doc(db, 'user_data', currentUserId, 'site_config', 'main_settings');

            const logoutBtn = document.getElementById('logoutBtn');
            const eventUrlInput = document.getElementById('eventUrlInput');
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            const copyUrlFeedback = document.getElementById('copyUrlFeedback');
            const siteConfigForm = document.getElementById('siteConfigForm');
            const pageTitleInput = document.getElementById('pageTitleInput');
            const logoUploadInput = document.getElementById('logoUploadInput');
            const logoPreview = document.getElementById('logoPreview');
            const saveConfigBtn = document.getElementById('saveConfigBtn');
            const dayForm = document.getElementById('dayForm');
            const dayDocIdInput = document.getElementById('dayDocId');
            const dayNameInput = document.getElementById('dayName');
            const dayDateInput = document.getElementById('dayDate');
            const saveDayBtn = document.getElementById('saveDayBtn');
            const clearDayFormBtn = document.getElementById('clearDayFormBtn');
            const dayListBody = document.getElementById('dayListBody');
            const locationForm = document.getElementById('locationForm');
            const locationDocIdInput = document.getElementById('locationDocId');
            const locationNameInput = document.getElementById('locationName');
            const saveLocationBtn = document.getElementById('saveLocationBtn');
            const clearLocationFormBtn = document.getElementById('clearLocationFormBtn');
            const locationListBody = document.getElementById('locationListBody');
            const activityForm = document.getElementById('activityForm');
            const activityDocIdInput = document.getElementById('activityDocId');
            const activityDaySelect = document.getElementById('activityDaySelect');
            const activityTimeInput = document.getElementById('activityTime');
            const activityDurationInput = document.getElementById('activityDuration');
            const autoAdjustContainer = document.getElementById('autoAdjustContainer');
            const autoAdjustCheckbox = document.getElementById('autoAdjustCheckbox');
            const activityNameInput = document.getElementById('activityName');
            const activityLocationSelect = document.getElementById('activityLocationSelect');
            const saveActivityBtn = document.getElementById('saveActivityBtn');
            const clearActivityFormBtn = document.getElementById('clearActivityFormBtn');
            const dayFilterSelect = document.getElementById('dayFilterSelect');
            const adminProgramBody = document.getElementById('adminProgramBody');
            const loadingIndicator = document.getElementById('loadingIndicator');

            let program = [];
            let locations = [];
            let days = [];
            let selectedDayId = null;

            logoutBtn.addEventListener('click', () => signOut(auth).catch(error => console.error("Erro no logout:", error)));
            const baseURL = 'https://pgmt.tec.br/';
            const eventURL = `${baseURL}?evento=${currentUserId}`;
            eventUrlInput.value = eventURL;
            copyUrlBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(eventUrlInput.value).then(() => {
                    copyUrlFeedback.style.display = 'inline';
                    copyUrlBtn.textContent = 'Copiado!';
                    setTimeout(() => {
                        copyUrlFeedback.style.display = 'none';
                        copyUrlBtn.textContent = 'Copiar URL';
                    }, 2500);
                }).catch(err => console.error('Falha ao copiar a URL: ', err));
            });

            async function loadSiteConfig() {
                try {
                    const docSnap = await getDoc(siteConfigRef);
                    if (docSnap.exists()) {
                        const config = docSnap.data();
                        if (config.pageTitle) pageTitleInput.value = config.pageTitle;
                        if (config.logoBase64) {
                            logoPreview.src = config.logoBase64;
                            logoPreview.style.display = 'block';
                        }
                    }
                } catch (error) { console.error("Erro ao carregar configurações do site:", error); }
            }

            logoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        logoPreview.src = event.target.result;
                        logoPreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });

            siteConfigForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveConfigBtn.disabled = true;
                const newTitle = pageTitleInput.value.trim();
                const file = logoUploadInput.files[0];
                const configToSave = { pageTitle: newTitle };
                try {
                    if (file) {
                        const base64String = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                            reader.readAsDataURL(file);
                        });
                        configToSave.logoBase64 = base64String;
                    }
                    await setDoc(siteConfigRef, configToSave, { merge: true });
                    alert('Configurações salvas com sucesso!');
                } catch (error) {
                    console.error("Erro ao salvar configurações:", error);
                } finally {
                    saveConfigBtn.disabled = false;
                }
            });

            async function loadDays() {
                try {
                    const q = query(daysCollectionRef, orderBy("date"));
                    const snapshot = await getDocs(q);
                    days = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) { console.error("Erro ao carregar dias:", error); days = []; }
            }

            function renderDays() {
                dayListBody.innerHTML = '';
                if (days.length === 0) { dayListBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Nenhum dia cadastrado.</td></tr>`; return; }
                days.forEach(day => {
                    const row = document.createElement('tr');
                    const formattedDate = new Date(day.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    row.innerHTML = `<td>${day.name}</td><td>${formattedDate}</td><td class="action-buttons"><button class="edit-day-btn" data-id="${day.id}">Editar</button><button class="delete-day-btn" data-id="${day.id}">Excluir</button></td>`;
                    dayListBody.appendChild(row);
                });
            }

            function populateDaySelects() {
                const hasDays = days.length > 0;
                activityDaySelect.innerHTML = hasDays ? '' : '<option value="">Primeiro, cadastre um dia</option>';
                dayFilterSelect.innerHTML = hasDays ? '' : '<option value="">Nenhum dia cadastrado</option>';
                days.forEach(day => {
                    activityDaySelect.add(new Option(day.name, day.id));
                    dayFilterSelect.add(new Option(day.name, day.id));
                });
                if (hasDays && (!selectedDayId || !days.some(d => d.id === selectedDayId))) {
                    selectedDayId = days[0].id;
                }
                dayFilterSelect.value = selectedDayId;
                activityDaySelect.value = selectedDayId;
            }

            function clearDayForm() {
                dayForm.reset();
                dayDocIdInput.value = '';
                saveDayBtn.textContent = 'Adicionar Dia';
                dayNameInput.focus();
            }
            clearDayFormBtn.addEventListener('click', clearDayForm);

            dayForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveDayBtn.disabled = true;
                saveDayBtn.textContent = 'Salvando...';
                const dayData = { name: dayNameInput.value.trim(), date: dayDateInput.value };
                const docId = dayDocIdInput.value;
                try {
                    if (docId) {
                        const dayDocRef = doc(daysCollectionRef, docId);
                        await updateDoc(dayDocRef, dayData);
                    } else {
                        const newDocRef = await addDoc(daysCollectionRef, dayData);
                        selectedDayId = newDocRef.id;
                    }
                    await loadDays();
                    renderDays();
                    populateDaySelects();
                    clearDayForm();
                } catch (error) {
                    console.error("Erro ao salvar dia:", error);
                    alert("Ocorreu um erro ao salvar o dia.");
                } finally {
                    saveDayBtn.disabled = false;
                    saveDayBtn.textContent = dayDocIdInput.value ? 'Salvar Edição' : 'Adicionar Dia';
                }
            });

            dayListBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const docId = target.dataset.id;
                const day = days.find(d => d.id === docId);

                if (target.classList.contains('edit-day-btn')) {
                    dayDocIdInput.value = day.id;
                    dayNameInput.value = day.name;
                    dayDateInput.value = day.date;
                    saveDayBtn.textContent = 'Salvar Edição';
                    dayNameInput.focus();
                } else if (target.classList.contains('delete-day-btn')) {
                    if (confirm(`Tem certeza que deseja excluir o "${day.name}"? ISSO REMOVERÁ TODAS AS ATIVIDADES DESTE DIA.`)) {
                        const activitiesToDeleteQuery = query(programCollectionRef, where("dayId", "==", docId));
                        const activitiesSnapshot = await getDocs(activitiesToDeleteQuery);
                        const batch = writeBatch(db);
                        activitiesSnapshot.forEach(docToDelete => batch.delete(docToDelete.ref));
                        batch.delete(doc(daysCollectionRef, docId));
                        await batch.commit();
                        selectedDayId = null;
                        await initializePage();
                    }
                }
            });

            async function loadLocationsFromFirestore() {
                try {
                    const q = query(locationsCollectionRef, orderBy("name"));
                    locations = (await getDocs(q)).docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) { console.error("Erro ao carregar locais:", error); locations = []; }
            }

            function renderLocations() {
                locationListBody.innerHTML = '';
                activityLocationSelect.innerHTML = '<option value="">Selecione um local</option>';
                if (locations.length === 0) { locationListBody.innerHTML = `<tr><td colspan="2" style="text-align:center;">Nenhum local cadastrado.</td></tr>`; }
                else {
                    locations.forEach(loc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${loc.name}</td><td class="action-buttons"><button class="edit-location-btn" data-id="${loc.id}">Editar</button><button class="delete-location-btn" data-id="${loc.id}">Excluir</button></td>`;
                        locationListBody.appendChild(row);
                        activityLocationSelect.add(new Option(loc.name, loc.id));
                    });
                }
            }

            function clearLocationForm() {
                locationForm.reset();
                locationDocIdInput.value = '';
                saveLocationBtn.textContent = 'Adicionar Local';
                locationNameInput.focus();
            }
            clearLocationFormBtn.addEventListener('click', clearLocationForm);

            locationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveLocationBtn.disabled = true;
                saveLocationBtn.textContent = 'Salvando...';
                const name = locationNameInput.value.trim();
                const docId = locationDocIdInput.value;
                try {
                    if (docId) await updateDoc(doc(locationsCollectionRef, docId), { name });
                    else await addDoc(locationsCollectionRef, { name });
                    await loadLocationsFromFirestore();
                    renderLocations();
                    clearLocationForm();
                } catch (error) {
                    console.error("Erro ao salvar local:", error);
                } finally {
                    saveLocationBtn.disabled = false;
                    saveLocationBtn.textContent = locationDocIdInput.value ? 'Salvar Edição' : 'Adicionar Local';
                }
            });

            locationListBody.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const docId = target.dataset.id;
                const location = locations.find(l => l.id === docId);
                if (target.classList.contains('edit-location-btn')) {
                    locationNameInput.value = location.name;
                    locationDocIdInput.value = location.id;
                    saveLocationBtn.textContent = 'Salvar Edição';
                    locationNameInput.focus();
                } else if (target.classList.contains('delete-location-btn')) {
                    if (confirm(`Tem certeza que deseja excluir o local "${location.name}"?`)) {
                        try {
                            await deleteDoc(doc(locationsCollectionRef, docId));
                            await loadLocationsFromFirestore();
                            renderLocations();
                        } catch (error) { console.error("Erro ao excluir local:", error); }
                    }
                }
            });

            dayFilterSelect.addEventListener('change', (e) => {
                selectedDayId = e.target.value;
                activityDaySelect.value = selectedDayId;
                refreshAdminProgramDataAndTable();
            });

            function clearActivityForm() {
                activityForm.reset();
                activityDocIdInput.value = '';
                saveActivityBtn.textContent = 'Adicionar Atividade';
                autoAdjustContainer.style.display = 'none';
                autoAdjustCheckbox.checked = false;
                if (selectedDayId) {
                    activityDaySelect.value = selectedDayId;
                }
                activityDaySelect.focus();
            }
            clearActivityFormBtn.addEventListener('click', clearActivityForm);

            activityForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!activityDaySelect.value) { alert("Por favor, selecione um dia para a atividade."); return; }
                saveActivityBtn.disabled = true;
                saveActivityBtn.textContent = 'Salvando...';
                const activityData = {
                    dayId: activityDaySelect.value, time: activityTimeInput.value,
                    duration: parseInt(activityDurationInput.value, 10),
                    activity: activityNameInput.value.trim(), locationId: activityLocationSelect.value
                };
                const docIdValue = activityDocIdInput.value;
                try {
                    if (docIdValue) await updateDoc(doc(programCollectionRef, docIdValue), activityData);
                    else await addDoc(programCollectionRef, activityData);
                    await refreshAdminProgramDataAndTable();
                    clearActivityForm();
                } catch (error) {
                    console.error("Erro ao salvar atividade:", error);
                } finally {
                    saveActivityBtn.disabled = false;
                    saveActivityBtn.textContent = activityDocIdInput.value ? 'Salvar Edição' : 'Adicionar Atividade';
                }
            });

            adminProgramBody.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                const docId = targetButton.dataset.id;
                const item = program.find(p => p.id === docId);
                if (targetButton.classList.contains('edit-btn')) {
                    activityDocIdInput.value = item.id;
                    activityDaySelect.value = item.dayId;
                    activityTimeInput.value = item.time;
                    activityDurationInput.value = item.duration || '';
                    activityNameInput.value = item.activity;
                    activityLocationSelect.value = item.locationId;
                    saveActivityBtn.textContent = 'Salvar Edição';
                    autoAdjustContainer.style.display = 'flex';
                    activityDaySelect.focus();
                } else if (targetButton.classList.contains('delete-btn')) {
                    if (confirm(`Tem certeza que deseja excluir esta atividade?`)) {
                        await deleteDoc(doc(programCollectionRef, docId));
                        await refreshAdminProgramDataAndTable();
                    }
                }
            });

            async function loadProgramFromFirestore(dayId) {
                loadingIndicator.classList.add('active');
                adminProgramBody.innerHTML = '';
                try {
                    if (!dayId) { program = []; return; }
                    const q = query(programCollectionRef, where("dayId", "==", dayId), orderBy("time"));
                    const snapshot = await getDocs(q);
                    program = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error("ERRO CRÍTICO AO BUSCAR PROGRAMAÇÃO:", error);
                    program = [];
                } finally {
                    loadingIndicator.classList.remove('active');
                }
            }

            function renderAdminProgram() {
                adminProgramBody.innerHTML = '';
                if (!selectedDayId) { adminProgramBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Cadastre e/ou selecione um dia para ver a programação.</td></tr>`; return; }
                if (program.length === 0) { adminProgramBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Nenhuma atividade programada para este dia.</td></tr>`; return; }
                program.forEach(item => {
                    const locationName = locations.find(loc => loc.id === item.locationId)?.name || 'N/D';
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${item.time}</td><td>${item.activity}</td><td>${locationName}</td><td class="action-buttons"><button class="edit-btn" data-id="${item.id}">Editar</button><button class="delete-btn" data-id="${item.id}">Excluir</button></td>`;
                    adminProgramBody.appendChild(row);
                });
            }

            async function refreshAdminProgramDataAndTable() {
                await loadProgramFromFirestore(selectedDayId);
                renderAdminProgram();
            }

            async function initializePage() {
                await loadSiteConfig();
                await loadLocationsFromFirestore();
                await loadDays();
                renderLocations();
                renderDays();
                populateDaySelects();
                await refreshAdminProgramDataAndTable();
            }

            initializePage();
        }
    </script>
</body>

</html>