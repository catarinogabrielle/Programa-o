<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programação</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="img/icon.png" id="favicon">

    <style>
        :root {
            --bg-page: #121212;
            --bg-card: #1E1E1E;
            --bg-header: linear-gradient(90deg, #1e3a8a, #2563eb);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EAEAEA;
            --text-secondary: #A9A9AA;
            --text-on-accent: #FFFFFF;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        main#main-content {
            flex: 1;
        }

        .header {
            text-align: center;
            margin: 16px 0 10px 0;
        }

        .header-logo {
            max-width: 140px;
            margin-bottom: 20px;
            height: auto;
        }

        h1 {
            font-size: 29px;
            font-weight: 600;
        }

        h2 {
            font-size: 24px;
            margin: 0 0 20px;
            text-align: center;
        }

        .panel {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 15px 20px;
        }

        #current-time-display {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 400px;
            margin: 12px auto 40px auto;
        }

        .time-clock {
            font-size: 21px;
            font-weight: 600;
        }

        .time-legend {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-green {
            background-color: var(--accent-green);
        }

        .dot-red {
            background-color: var(--accent-red);
        }

        .now-next-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .now-next-group .group-title {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .card {
            padding: 15px;
            border-radius: var(--border-radius-sm);
            color: var(--text-on-accent);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card.current-activity {
            background-color: var(--accent-green);
        }

        .card.next-activity {
            background-color: var(--accent-red);
        }

        .card.no-activity {
            background-color: transparent;
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .card .time-slot {
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .card .activity-name {
            font-size: 16px;
            font-weight: 600;
        }

        .card .countdown {
            font-size: 13px;
            margin-top: 8px;
            opacity: 0.9;
        }

        #day-selector-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .day-selector-btn {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .day-selector-btn:hover {
            border-color: var(--text-primary);
        }

        .day-selector-btn.active {
            background: var(--bg-header);
            color: var(--text-on-accent);
            border-color: transparent;
            font-weight: 600;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        #program-list table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        #program-list th,
        #program-list td {
            padding: 14px;
            text-align: left;
            vertical-align: middle;
        }

        #program-list thead tr {
            background: var(--bg-header);
        }

        #program-list thead th {
            background: transparent;
            color: var(--text-on-accent);
            font-weight: 600;
            font-size: 14px;
            border: none;
        }

        #program-list thead th:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        #program-list thead th:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #program-list tbody tr {
            background-color: var(--bg-card);
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        #program-list tbody tr td:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        #program-list tbody tr td:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #program-list tbody tr.active-row {
            background-color: var(--accent-green);
            color: var(--text-on-accent);
            font-weight: 500;
        }

        #program-list tbody tr.upcoming-row {
            background-color: var(--accent-red);
            color: var(--text-on-accent);
            font-weight: 500;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .header {
                margin: 10px 0 10px 0;
            }

            h1 {
                font-size: 22px;
            }

            h2 {
                font-size: 19px;
            }

            .card .activity-name {
                font-size: 14px;
            }

            #day-selector-container {
                margin-bottom: 20px;
            }

            #program-list th,
            #program-list td {
                padding: 12px 10px;
                font-size: 14px;
            }

            #program-list th:nth-child(1),
            #program-list td:nth-child(1) {
                width: 15%;
                text-align: center;
            }

            #program-list th:nth-child(3),
            #program-list td:nth-child(3) {
                width: 25%;
                text-align: center;
            }
        }
    </style>
</head>

<body class="dark-mode">
    <div class="container">
        <header class="header">
            <img src="img/logo.png" alt="Logo do Evento" class="header-logo" id="headerLogo">
            <h1 id="pageTitle">Programação</h1>
        </header>

        <main id="main-content">
            <section id="current-time-display" class="panel">
                <div class="time-clock" aria-live="polite"><span id="time-value">--:--:--</span></div>
                <div class="time-legend">
                    <div class="legend-item"><span class="legend-dot dot-green"></span> Agora</div>
                    <div class="legend-item"><span class="legend-dot dot-red"></span> A seguir</div>
                </div>
            </section>

            <section class="now-next-sections" id="now-next-display"></section>
            <h2 id="program-title">Programação</h2>
            <div id="day-selector-container"></div>
            <section id="program-list">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Horário</th>
                                <th>Atividade</th>
                                <th>Local</th>
                            </tr>
                        </thead>
                        <tbody id="program-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
        <footer>
            <p>Todos os direitos reservados Live7 LTDA</p>
            <p style="display: flex; align-items: center; justify-content: center; margin-top: 15px;">Tecnologia By The
                Doctors
                <img src="img/logo.png" alt="Logo do Evento" style="width: 120px; margin-left: 8px; cursor: pointer;">
            </p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8EGMHVUVTrNWY2wai3YmXE1ZrlZ6Gz6o",
            authDomain: "programacao-9b5ff.firebaseapp.com",
            projectId: "programacao-9b5ff",
            storageBucket: "programacao-9b5ff.appspot.com",
            messagingSenderId: "454543714542",
            appId: "1:454543714542:web:0d57bf8de021d5e79e6bff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const state = { program: [], locations: [], days: [], selectedDayId: null, lastUpdatedMinute: -1, };
        let isFirstLoad = true;

        const pageTitleElement = document.getElementById('pageTitle');
        const programTitleElement = document.getElementById('program-title');
        const headerLogo = document.getElementById('headerLogo');
        const mainContent = document.getElementById('main-content');
        const timeValueDisplay = document.getElementById('time-value');
        const nowNextDisplayContainer = document.getElementById('now-next-display');
        const programBody = document.getElementById('program-body');
        const favicon = document.getElementById('favicon');
        const daySelectorContainer = document.getElementById('day-selector-container');
        const currentTimeDisplay = document.getElementById('current-time-display');

        const timeToMinutes = (timeString) => {
            if (!timeString) return 0;
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        };

        function rerenderUI() {
            if (isFirstLoad && state.days.length > 0) {
                determineInitialDay();
                isFirstLoad = false;
            }

            const selectedDayExists = state.days.some(day => day.id === state.selectedDayId);
            if (!selectedDayExists && state.days.length > 0) {
                state.selectedDayId = state.days[0].id;
            }

            renderDaySelectors();
            updateSchedule();
        }

        function setupRealtimeListeners(userId) {
            const daysCollectionRef = collection(db, 'user_data', userId, 'eventDays');
            const programCollectionRef = collection(db, 'user_data', userId, 'eventProgram');
            const locationsCollectionRef = collection(db, 'user_data', userId, 'eventLocations');
            const siteConfigRef = doc(db, 'user_data', userId, 'site_config', 'main_settings');

            onSnapshot(siteConfigRef, (doc) => {
                if (doc.exists()) {
                    const configData = doc.data();
                    pageTitleElement.textContent = configData.pageTitle || "Programação do Evento";
                    document.title = pageTitleElement.textContent;
                    if (configData.logoBase64) {
                        headerLogo.src = configData.logoBase64;
                        favicon.href = configData.logoBase64;
                    }
                }
            }, (error) => console.error("Erro ao ouvir config: ", error));

            onSnapshot(query(daysCollectionRef, orderBy("date")), (snapshot) => {
                state.days = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderUI();
            }, (error) => console.error("Erro ao ouvir dias: ", error));

            onSnapshot(query(locationsCollectionRef, orderBy("name")), (snapshot) => {
                state.locations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderUI();
            }, (error) => console.error("Erro ao ouvir locais: ", error));

            onSnapshot(query(programCollectionRef), (snapshot) => {
                state.program = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderUI();
            }, (error) => console.error("Erro ao ouvir programação: ", error));
        }


        function determineInitialDay() {
            if (state.days.length === 0) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const todayEvent = state.days.find(day => day.date === todayStr);
            state.selectedDayId = todayEvent ? todayEvent.id : state.days[0].id;
        }

        function renderDaySelectors() {
            daySelectorContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            state.days.forEach(day => {
                const button = document.createElement('button');
                button.className = 'day-selector-btn';
                button.textContent = day.name;
                button.dataset.dayId = day.id;
                if (day.id === state.selectedDayId) button.classList.add('active');
                fragment.appendChild(button);
            });
            daySelectorContainer.appendChild(fragment);
        }

        daySelectorContainer.addEventListener('click', (e) => {
            if (e.target.matches('.day-selector-btn')) {
                state.selectedDayId = e.target.dataset.dayId;
                renderDaySelectors();
                updateSchedule();
            }
        });

        function getProgramForSelectedDay() {
            if (!state.selectedDayId) return [];
            return state.program.filter(activity => activity.dayId === state.selectedDayId);
        }

        function getEventStatus(now, schedule) {
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            const scheduleWithStatus = schedule.map(item => ({ ...item, status: 'past' }));
            let nowTime = null, nextTime = null;
            const sortedProgram = [...schedule].sort((a, b) => a.time.localeCompare(b.time));
            for (const item of sortedProgram) {
                const startTime = timeToMinutes(item.time);
                const endTime = startTime + (item.duration || 60);
                if (currentTimeInMinutes >= startTime && currentTimeInMinutes < endTime) nowTime = item.time;
                if (startTime > currentTimeInMinutes && !nextTime) nextTime = item.time;
            }
            scheduleWithStatus.forEach(item => {
                if (item.time === nowTime) item.status = 'now';
                else if (item.time === nextTime) item.status = 'next';
            });
            return { schedule: scheduleWithStatus };
        }

        function renderNowNextCards(now, programForCards) {
            nowNextDisplayContainer.innerHTML = '';
            if (!state.locations || state.locations.length === 0) return;
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            const fragment = document.createDocumentFragment();
            const programByLocation = programForCards.reduce((acc, activity) => {
                const locId = activity.locationId || 'unassigned';
                if (!acc[locId]) acc[locId] = [];
                acc[locId].push(activity);
                return acc;
            }, {});

            for (const locationId in programByLocation) {
                const location = state.locations.find(l => l.id === locationId);
                const locationName = location ? location.name : "Local não definido";
                const eventsForLocation = programByLocation[locationId];
                const currentEvent = eventsForLocation.find(event => {
                    const startTime = timeToMinutes(event.time);
                    const endTime = startTime + (event.duration || 60);
                    return currentTimeInMinutes >= startTime && currentTimeInMinutes < endTime;
                });
                const nextEvent = eventsForLocation.filter(event => timeToMinutes(event.time) > currentTimeInMinutes).sort((a, b) => a.time.localeCompare(b.time))[0];

                if (currentEvent || nextEvent) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'now-next-group panel';
                    const createCard = (event, type) => {
                        if (!event) return `<div class="card no-activity"><p>Nenhuma atividade</p></div>`;
                        const cardClass = type === 'now' ? 'current-activity' : 'next-activity';
                        const countdownHtml = type === 'next' ? `<p class="countdown" data-starttime="${event.time}"></p>` : '';
                        return `<div class="card ${cardClass}"><p class="time-slot">${event.time}</p><p class="activity-name">${event.activity}</p>${countdownHtml}</div>`;
                    };
                    groupDiv.innerHTML = `<div class="group-title">${locationName}</div><div class="cards-container">${createCard(currentEvent, 'now')}${createCard(nextEvent, 'next')}</div>`;
                    fragment.appendChild(groupDiv);
                }
            }
            nowNextDisplayContainer.appendChild(fragment);
        }

        function renderProgramTable(schedule) {
            programBody.innerHTML = '';
            if (!schedule || schedule.length === 0) {
                programBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Nenhuma programação disponível para este dia.</td></tr>`;
                return;
            }
            const fragment = new DocumentFragment();
            const sortedSchedule = [...schedule].sort((a, b) => a.time.localeCompare(b.time));

            sortedSchedule.forEach(item => {
                const locationName = state.locations.find(loc => loc.id === item.locationId)?.name || 'N/A';
                const row = document.createElement('tr');
                if (item.status === 'now') row.className = 'active-row';
                else if (item.status === 'next') row.className = 'upcoming-row';
                row.innerHTML = `<td>${item.time}</td><td>${item.activity}</td><td>${locationName}</td>`;
                fragment.appendChild(row);
            });
            programBody.appendChild(fragment);
        }

        function updateAllCountdowns() {
            document.querySelectorAll('.countdown').forEach(element => {
                const startTime = element.dataset.starttime;
                if (!startTime) return;
                const [hours, minutes] = startTime.split(':').map(Number);
                const now = new Date();
                const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
                const diffInSeconds = Math.floor((eventTime - now) / 1000);
                if (diffInSeconds > 0) {
                    const s = diffInSeconds % 60;
                    const m = Math.floor(diffInSeconds / 60) % 60;
                    const h = Math.floor(diffInSeconds / 3600);
                    element.textContent = `Começa em: ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                } else {
                    element.textContent = "Começando...";
                }
            });
        }

        function updateSchedule() {
            const now = new Date();
            const selectedDayData = state.days.find(d => d.id === state.selectedDayId);

            if (!selectedDayData) {
                programTitleElement.textContent = 'Programação';
                nowNextDisplayContainer.style.display = 'none';
                currentTimeDisplay.style.display = 'none';
                programBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Nenhum dia selecionado.</td></tr>`;
                return;
            }

            programTitleElement.textContent = `Programação de ${selectedDayData.name}`;

            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = selectedDayData.date === todayStr;

            const programForDisplay = getProgramForSelectedDay();

            if (isToday) {
                currentTimeDisplay.style.display = 'flex';
                nowNextDisplayContainer.style.display = 'grid';

                const processedData = getEventStatus(now, programForDisplay);
                renderProgramTable(processedData.schedule);
                renderNowNextCards(now, programForDisplay);
            } else {
                currentTimeDisplay.style.display = 'none';
                nowNextDisplayContainer.style.display = 'none';

                const scheduleWithoutStatus = programForDisplay.map(item => ({ ...item, status: 'none' }));
                renderProgramTable(scheduleWithoutStatus);
            }
        }

        function updateDisplay() {
            const now = new Date();
            timeValueDisplay.textContent = now.toLocaleTimeString('pt-BR');

            const selectedDayData = state.days.find(d => d.id === state.selectedDayId);
            if (!selectedDayData) return;

            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = selectedDayData.date === todayStr;

            if (isToday) {
                const currentMinute = now.getMinutes();
                if (currentMinute !== state.lastUpdatedMinute) {
                    state.lastUpdatedMinute = currentMinute;
                    updateSchedule();
                }
                updateAllCountdowns();
            }
        }

        function initialize() {
            const urlParams = new URLSearchParams(window.location.search);
            const eventUserId = urlParams.get('evento');
            if (eventUserId) {
                setupRealtimeListeners(eventUserId);
                setInterval(updateDisplay, 1000);
            } else {
                mainContent.innerHTML = `<h2 style="text-align: center;">Nenhum evento especificado.</h2>`;
            }
        }
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>