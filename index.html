<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programação do Evento</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="img/icon.png">

    <style>
        :root {
            --bg-page: #121212;
            --bg-card: #1E1E1E;
            --bg-header: linear-gradient(90deg, #1e3a8a, #2563eb);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EAEAEA;
            --text-secondary: #A9A9AA;
            --text-on-accent: #FFFFFF;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        body:not(.dark-mode) {
            --bg-page: #f0f2f5;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --text-primary: #1c1c1c;
            --text-secondary: #555555;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            padding: 20px 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin: 25px 0;
        }

        .header-logo {
            max-width: 140px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 29px;
            font-weight: 600;
        }

        h2 {
            font-size: 24px;
            margin: 40px 0 20px;
            text-align: center;
        }

        .panel {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 15px 20px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #current-time-display {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto 40px auto;
        }

        .time-clock {
            font-size: 21px;
            font-weight: 600;
        }

        .time-legend {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-green {
            background-color: var(--accent-green);
        }

        .dot-red {
            background-color: var(--accent-red);
        }

        .now-next-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .now-next-group .group-title {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .card {
            padding: 15px;
            border-radius: var(--border-radius-sm);
            color: var(--text-on-accent);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card.current-activity {
            background-color: var(--accent-green);
        }

        .card.next-activity {
            background-color: var(--accent-red);
        }

        .card.no-activity {
            background-color: transparent;
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .card .time-slot {
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .card .activity-name {
            font-size: 16px;
            font-weight: 600;
        }

        .card .countdown {
            font-size: 13px;
            margin-top: 8px;
            opacity: 0.9;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        #program-list table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        #program-list th,
        #program-list td {
            padding: 14px;
            text-align: left;
            vertical-align: middle;
            white-space: normal;
        }

        #program-list thead tr {
            background: var(--bg-header);
        }

        #program-list thead th {
            background: transparent;
            color: var(--text-on-accent);
            font-weight: 600;
            font-size: 14px;
            border: none;
        }

        #program-list thead th:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        #program-list thead th:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #program-list tbody tr {
            background-color: var(--bg-card);
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        #program-list tbody tr td:first-child {
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
        }

        #program-list tbody tr td:last-child {
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        #program-list tbody tr.active-row {
            background-color: var(--accent-green);
            color: var(--text-on-accent);
            font-weight: 500;
        }

        #program-list tbody tr.upcoming-row {
            background-color: var(--accent-red);
            color: var(--text-on-accent);
            font-weight: 500;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 35px;
            }

            h2 {
                font-size: 29px;
            }

            #program-list th,
            #program-list td {
                padding: 16px 20px;
                font-size: 16px;
            }

            #program-list th:nth-child(1),
            #program-list td:nth-child(1) {
                width: 15%;
                text-align: center;
            }

            #program-list th:nth-child(3),
            #program-list td:nth-child(3) {
                width: 25%;
                text-align: center;
            }
        }
    </style>
</head>

<body class="dark-mode">

    <div class="container">
        <header class="header">
            <img src="img/logo.png" alt="Logo do Evento" class="header-logo">
            <h1 id="pageTitle">Programação do Evento</h1>
        </header>

        <main>
            <section id="current-time-display" class="panel">
                <div class="time-clock" aria-live="polite">
                    <span id="time-value">--:--:--</span>
                </div>
                <div class="time-legend">
                    <div class="legend-item"><span class="legend-dot dot-green"></span> Agora</div>
                    <div class="legend-item"><span class="legend-dot dot-red"></span> A seguir</div>
                </div>
            </section>

            <section class="now-next-sections" id="now-next-display"></section>

            <section id="program-list">
                <h2>Programação Completa</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Horário</th>
                                <th>Atividade</th>
                                <th>Local</th>
                            </tr>
                        </thead>
                        <tbody id="program-body">
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <footer>
            <p>Tecnologia CATARINO'S</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8EGMHVUVTrNWY2wai3YmXE1ZrlZ6Gz6o",
            authDomain: "programacao-9b5ff.firebaseapp.com",
            projectId: "programacao-9b5ff",
            storageBucket: "programacao-9b5ff.appspot.com",
            messagingSenderId: "454543714542",
            appId: "1:454543714542:web:0d57bf8de021d5e79e6bff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const programCollectionRef = collection(db, 'eventProgram');
        const locationsCollectionRef = collection(db, 'eventLocations');
        const siteConfigRef = doc(db, 'site_config', 'main_settings');

        const state = {
            program: [],
            locations: [],
            lastUpdatedMinute: -1,
        };

        const pageTitleElement = document.getElementById('pageTitle');
        const timeValueDisplay = document.getElementById('time-value');
        const nowNextDisplayContainer = document.getElementById('now-next-display');
        const programBody = document.getElementById('program-body');

        const timeToMinutes = (timeString) => {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        };

        async function fetchData() {
            try {
                const [locationsSnapshot, programSnapshot, configDoc] = await Promise.all([
                    getDocs(query(locationsCollectionRef, orderBy("name"))),
                    getDocs(query(programCollectionRef, orderBy("time"))),
                    getDoc(siteConfigRef)
                ]);

                if (configDoc.exists() && configDoc.data().pageTitle) {
                    const newTitle = configDoc.data().pageTitle;
                    pageTitleElement.textContent = newTitle;
                    document.title = newTitle;
                } else {
                    pageTitleElement.textContent = "Programação do Evento";
                }

                state.locations = locationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.program = programSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                state.lastUpdatedMinute = -1;
                updateDisplay();

            } catch (error) {
                console.error("Erro ao carregar dados do Firestore: ", error);
                pageTitleElement.textContent = "Erro ao Carregar";
                programBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Erro ao carregar a programação.</td></tr>';
            }
        }

        function getEventStatus(now) {
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();

            const scheduleWithStatus = state.program.map(item => ({ ...item, status: 'past' }));
            const uniqueTimes = [...new Set(state.program.map(item => item.time))].sort((a, b) => a.localeCompare(b));

            let nowTime = null;
            let nextTime = null;

            for (let i = 0; i < uniqueTimes.length; i++) {
                const startTime = timeToMinutes(uniqueTimes[i]);
                const endTime = (i < uniqueTimes.length - 1) ? timeToMinutes(uniqueTimes[i + 1]) : startTime + 60;

                if (currentTimeInMinutes >= startTime && currentTimeInMinutes < endTime) {
                    nowTime = uniqueTimes[i];
                    nextTime = uniqueTimes[i + 1] || null;
                    break;
                }
                if (currentTimeInMinutes < startTime) {
                    nextTime = uniqueTimes[i];
                    break;
                }
            }

            scheduleWithStatus.forEach(item => {
                if (item.time === nowTime) item.status = 'now';
                else if (item.time === nextTime) item.status = 'next';
            });

            return { schedule: scheduleWithStatus, eventStatus: { now: nowTime, next: nextTime } };
        }

        function renderNowNextCards({ schedule }) {
            nowNextDisplayContainer.innerHTML = '';
            if (!state.locations) return;

            const fragment = new DocumentFragment();
            state.locations.forEach(loc => {
                const currentEvent = schedule.find(p => p.locationId === loc.id && p.status === 'now');
                const nextEvent = schedule.find(p => p.locationId === loc.id && p.status === 'next');

                if (!currentEvent && !nextEvent) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'now-next-group panel';

                const createCard = (event, type) => {
                    if (!event) {
                        return `<div class="card no-activity"><p>Nenhuma atividade</p></div>`;
                    }
                    const countdownHtml = type === 'next' ? `<p class="countdown" data-starttime="${event.time}"></p>` : '';
                    return `
                        <div class="card ${type === 'now' ? 'current-activity' : 'next-activity'}">
                            <p class="time-slot">${event.time}</p>
                            <p class="activity-name">${event.activity}</p>
                            ${countdownHtml}
                        </div>`;
                };

                groupDiv.innerHTML = `
                    <div class="group-title">${loc.name}</div>
                    <div class="cards-container">
                        ${createCard(currentEvent, 'now')}
                        ${createCard(nextEvent, 'next')}
                    </div>
                `;
                fragment.appendChild(groupDiv);
            });

            nowNextDisplayContainer.appendChild(fragment);
        }

        function renderProgramTable({ schedule, eventStatus }) {
            programBody.innerHTML = '';
            if (!state.program || state.program.length === 0) {
                programBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nenhuma programação disponível.</td></tr>';
                return;
            }

            const fragment = new DocumentFragment();
            schedule.forEach(item => {
                const locationName = state.locations.find(loc => loc.id === item.locationId)?.name || 'N/A';
                const row = document.createElement('tr');

                if (item.status === 'now') row.className = 'active-row';
                else if (item.status === 'next') row.className = 'upcoming-row';

                row.innerHTML = `<td>${item.time}</td><td>${item.activity}</td><td>${locationName}</td>`;
                fragment.appendChild(row);
            });

            programBody.appendChild(fragment);
        }

        function updateAllCountdowns() {
            document.querySelectorAll('.countdown').forEach(element => {
                const startTime = element.dataset.starttime;
                if (!startTime) return;

                const [hours, minutes] = startTime.split(':').map(Number);
                const now = new Date();
                const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);

                const diffInSeconds = Math.floor((eventTime - now) / 1000);

                if (diffInSeconds > 0) {
                    const s = diffInSeconds % 60;
                    const m = Math.floor(diffInSeconds / 60) % 60;
                    const h = Math.floor(diffInSeconds / 3600);
                    element.textContent = `Começa em: ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                } else {
                    element.textContent = diffInSeconds > -60 ? "Começando..." : "Evento iniciado";
                    element.style.opacity = "0.7";
                }
            });
        }

        function updateDisplay() {
            const now = new Date();
            timeValueDisplay.textContent = now.toLocaleTimeString('pt-BR');

            const currentMinute = now.getMinutes();
            if (currentMinute !== state.lastUpdatedMinute) {
                state.lastUpdatedMinute = currentMinute;

                if (state.program.length > 0) {
                    const processedData = getEventStatus(now);
                    renderNowNextCards(processedData);
                    renderProgramTable(processedData);
                }
            }

            updateAllCountdowns();
        }

        async function initialize() {
            await fetchData();

            setInterval(updateDisplay, 1000);

            setInterval(fetchData, 60000);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>

</body>

</html>